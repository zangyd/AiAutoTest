# 代码审查规则

## 一、审查流程

### 1. 提交阶段
- 开发人员在提交代码时必须遵循PR模板规范
- 每个PR必须关联相应的Issue
- PR标题必须符合约定的格式规范

### 2. 审查阶段
- 至少需要2名审查人员进行review
- 审查人员必须在2个工作日内完成review
- 提出的意见必须明确且有建设性

### 3. 修改阶段
- 开发人员必须对每条review意见做出响应
- 修改完成后需要重新请求review
- 所有问题解决后才能合并代码

## 二、审查重点

### 1. 代码质量
#### 1.1 可读性
- 命名规范且有意义
- 代码结构清晰
- 注释完整且必要
- 代码缩进和格式正确

#### 1.2 可维护性
- 遵循SOLID原则
- 避免代码重复
- 合理的模块划分
- 适当的抽象层次

#### 1.3 性能
- 算法复杂度合理
- 资源使用效率
- 数据库查询优化
- 缓存使用合理

### 2. 功能完整性
- 是否实现了需求文档中的所有功能
- 是否处理了各种边界情况
- 是否包含适当的错误处理
- 是否有完整的日志记录

### 3. 测试覆盖
- 单元测试覆盖率不低于80%
- 包含集成测试
- 测试用例是否合理
- 是否包含边界测试

### 4. 安全性
- 输入验证
- 权限控制
- 敏感信息处理
- SQL注入防护
- XSS防护

## 三、自动化检查

### 1. 后端代码检查
- Black代码格式化
- isort导入顺序
- mypy类型检查
- flake8代码风格
- bandit安全检查
- safety依赖检查

### 2. 前端代码检查
- ESLint规范检查
- TypeScript类型检查
- Prettier代码格式化
- npm audit依赖检查

## 四、审查清单

### 1. 代码风格
- [ ] 遵循项目编码规范
- [ ] 命名规范且有意义
- [ ] 代码格式正确
- [ ] 注释完整且必要

### 2. 代码质量
- [ ] 没有重复代码
- [ ] 函数职责单一
- [ ] 适当的抽象层次
- [ ] 错误处理完善

### 3. 测试
- [ ] 单元测试覆盖
- [ ] 测试用例合理
- [ ] 集成测试覆盖
- [ ] 边界情况测试

### 4. 安全
- [ ] 输入数据验证
- [ ] 权限检查
- [ ] 敏感信息保护
- [ ] SQL注入防护

### 5. 文档
- [ ] API文档更新
- [ ] 注释完整
- [ ] README更新
- [ ] 部署文档更新

## 五、合并条件

### 1. 自动化检查要求
- 所有自动化检查必须通过，包括：
  - 代码风格检查（Black/Prettier）
  - 静态类型检查（mypy/TypeScript）
  - 代码质量检查（flake8/ESLint）
  - 安全漏洞扫描（bandit/npm audit）
  - 依赖安全检查（safety/npm audit）
  - CI流水线所有阶段均通过

### 2. 代码审查要求
- 至少2名审查人员批准，且必须包括：
  - 1名高级开发人员
  - 1名模块负责人
- 所有review意见必须标记为已解决
- 不允许有未处理的review线程

### 3. 测试要求
- 单元测试覆盖率达到80%以上
- 所有新增功能必须包含集成测试
- 所有测试用例必须通过
- 性能测试指标符合要求

### 4. 文档要求
- API文档已同步更新
- 更新CHANGELOG.md
- 更新README.md（如有必要）
- 更新部署文档（如有必要）
- 添加数据库变更文档（如有必要）

### 5. 分支要求
- 目标分支必须是最新的
- 不存在合并冲突
- 分支命名符合规范
- 提交信息符合规范

### 6. 验证流程
1. 自动化验证
   - CI流水线全部通过
   - 代码质量门禁检查通过
   - 安全扫描无高危漏洞

2. 人工验证
   - 功能测试通过
   - 代码审查通过
   - 文档审查通过

3. 合并后验证
   - 部署验证通过
   - 冒烟测试通过
   - 监控指标正常

### 7. 紧急修复例外规则
- 需要项目负责人批准
- 至少1名高级开发人员审查
- 必须包含回归测试
- 后续补充完整文档

## 六、审查响应时间要求

1. 审查人员必须在2个工作日内完成首轮review
2. 开发人员必须在1个工作日内响应review意见
3. 紧急修复可以申请加急审查流程

## 七、最佳实践

1. 每个PR控制在300行代码以内
2. 提交前进行自测
3. 编写清晰的PR描述
4. 及时响应review意见
5. 保持良好的沟通

## 八、版本标签规则

### 1. 版本号规范
- 格式：v{major}.{minor}.{patch}
  * major：主版本号，重大功能变更
  * minor：次版本号，新功能发布
  * patch：修订号，bug修复和小改动
- 示例：v1.0.0, v1.1.0, v1.1.1

### 2. 环境标签规范
- 格式：{env}-{timestamp}
  * env：环境标识（prod/test/dev）
  * timestamp：时间戳（YYYYMMDD）
- 示例：prod-20240401, test-20240401, dev-20240401

### 3. 里程碑标签规范
- 格式：milestone-{name}-{date}
  * name：里程碑名称
  * date：日期（YYYYMMDD）
- 示例：milestone-beta-20240401

### 4. 标签创建流程
1. 前置条件
   - 代码审查完成并通过
   - 自动化测试全部通过
   - 合并请求已被批准
   - 文档更新完成

2. 创建步骤
   - 确认目标分支最新状态
   - 创建带注释的标签
   - 添加详细的标签说明
   - 推送标签到远程仓库

3. 标签说明要求
   - 版本号
   - 发布日期
   - 主要更新内容
   - 重要变更说明
   - 兼容性说明
   - 相关文档链接

### 5. 标签管理规则
1. 权限控制
   - 只有项目管理员和发布管理员可以创建/删除生产环境标签
   - 开发人员可以创建开发环境标签
   - 测试人员可以创建测试环境标签

2. 标签保护
   - 生产环境标签禁止删除
   - 里程碑标签禁止删除
   - 历史版本标签禁止修改

3. 标签维护
   - 定期清理临时标签
   - 维护标签文档
   - 更新版本记录

## 九、合并规则补充

### 1. 分支合并策略
1. 开发分支合并到测试分支
   - 必须通过代码审查
   - 必须通过单元测试
   - 必须更新相关文档

2. 测试分支合并到预发布分支
   - 必须通过集成测试
   - 必须通过性能测试
   - 必须完成功能验收

3. 预发布分支合并到主分支
   - 必须通过完整测试套件
   - 必须完成安全扫描
   - 必须更新版本号
   - 必须创建版本标签

### 2. 合并后操作
1. 清理工作
   - 删除已合并的功能分支
   - 更新相关任务状态
   - 关闭相关问题单

2. 验证工作
   - 部署后验证
   - 监控系统检查
   - 日志检查
   - 性能指标检查

3. 文档工作
   - 更新CHANGELOG
   - 更新API文档
   - 更新部署文档
   - 更新版本说明

### 3. 紧急修复流程补充
1. 创建修复分支
   - 从生产标签创建
   - 使用hotfix-前缀
   - 包含问题编号

2. 快速审查流程
   - 简化审查流程
   - 关注修复范围
   - 确保不引入新问题

3. 合并要求
   - 同时合并到主分支和开发分支
   - 创建修复版本标签
   - 更新修复文档 